<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>NERO SENSE COMMAND</title>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --tron-cyan: #00f3ff;
      --tron-bg: #000808;
      --tron-dark: #001111;
      --matrix-green: #00ff41;
      --matrix-bg: #000500;
      --matrix-dark: #001100;
    }

    body {
      background: #000;
      color: #fff;
      font-family: 'Orbitron', sans-serif;
      margin: 0;
      display: flex;
      flex-direction: column;
      height: 100vh;
      overflow: hidden;
    }

    /* --- HEADER --- */
    header {
      padding: 15px 30px;
      background: linear-gradient(90deg, rgba(0, 20, 20, 0.9) 0%, rgba(0, 0, 0, 0.9) 100%);
      border-bottom: 2px solid var(--tron-cyan);
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 0 20px rgba(0, 243, 255, 0.2);
      z-index: 10;
    }

    h1 {
      margin: 0;
      letter-spacing: 8px;
      font-size: 24px;
      color: var(--tron-cyan);
      text-shadow: 0 0 10px var(--tron-cyan);
    }

    .sys-status {
      font-family: 'Orbitron', sans-serif;
      color: var(--tron-cyan);
      font-size: 14px;
    }

    #main {
      display: flex;
      flex: 1;
      position: relative;
    }

    /* --- PANELS --- */
    .radar-panel {
      flex: 1;
      position: relative;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    /* TRON THEME */
    .theme-tron {
      background: radial-gradient(circle at center, var(--tron-dark) 0%, #000 100%);
      border-right: 2px solid var(--tron-cyan);
    }

    .theme-tron .panel-header {
      background: rgba(0, 20, 20, 0.8);
      border-bottom: 1px solid var(--tron-cyan);
      color: var(--tron-cyan);
    }

    .theme-tron input {
      border: 1px solid var(--tron-cyan);
      color: var(--tron-cyan);
      box-shadow: 0 0 5px var(--tron-cyan);
    }

    .theme-tron button {
      background: rgba(0, 243, 255, 0.1);
      border: 1px solid var(--tron-cyan);
      color: var(--tron-cyan);
    }

    .theme-tron button:hover {
      background: var(--tron-cyan);
      color: #000;
      box-shadow: 0 0 15px var(--tron-cyan);
    }

    .theme-tron .data-display {
      color: var(--tron-cyan);
      text-shadow: 0 0 5px var(--tron-cyan);
    }

    /* MATRIX THEME */
    .theme-matrix {
      background: #000;
      position: relative;
    }

    /* Matrix rain overlay effect */
    .theme-matrix::before {
      content: "";
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(0deg, rgba(0, 20, 0, 0.2) 25%, rgba(0, 0, 0, 0) 100%);
      background-size: 4px 4px;
      pointer-events: none;
      z-index: 0;
    }

    .theme-matrix .panel-header {
      background: rgba(0, 20, 0, 0.9);
      border-bottom: 1px solid var(--matrix-green);
      color: var(--matrix-green);
      font-family: 'Orbitron', sans-serif;
    }

    .theme-matrix input {
      border: 1px solid var(--matrix-green);
      color: var(--matrix-green);
      font-family: 'Orbitron', sans-serif;
      background: #000;
    }

    .theme-matrix button {
      background: #000;
      border: 1px solid var(--matrix-green);
      color: var(--matrix-green);
      font-family: 'Orbitron', sans-serif;
    }

    .theme-matrix button:hover {
      background: var(--matrix-green);
      color: #000;
    }

    .theme-matrix .data-display {
      color: var(--matrix-green);
      font-family: 'Orbitron', sans-serif;
    }

    /* --- COMMON UI --- */
    .panel-header {
      padding: 15px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      z-index: 2;
    }

    .panel-title {
      font-size: 18px;
      font-weight: bold;
      letter-spacing: 2px;
    }

    .controls {
      display: flex;
      gap: 10px;
      align-items: center;
    }

    input {
      background: transparent;
      padding: 8px;
      font-size: 14px;
      width: 140px;
      outline: none;
      text-align: center;
    }

    .input-small {
      width: 80px;
    }

    button {
      padding: 8px 20px;
      cursor: pointer;
      font-weight: bold;
      transition: all 0.3s ease;
      text-transform: uppercase;
    }

    .status {
      font-weight: bold;
      margin-left: 10px;
      opacity: 0.7;
    }

    .status.connected {
      opacity: 1;
      text-shadow: 0 0 10px currentColor;
    }

    /* --- DATA OVERLAY --- */
    .data-overlay {
      position: absolute;
      bottom: 20px;
      left: 20px;
      z-index: 5;
      font-size: 16px;
      line-height: 1.5;
      pointer-events: none;
    }

    .data-row {
      display: flex;
      gap: 15px;
    }

    .label {
      opacity: 0.7;
    }

    .value {
      font-weight: bold;
    }

    canvas {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: 1;
    }
  </style>
</head>

<body>

  <header>
    <h1>NERO SENSE COMMAND</h1>
    <div class="sys-status">SYSTEM STATUS: <span id="global-status" style="color:#fff">ACTIVE</span></div>
  </header>

  <div id="main">
    <!-- SYSTEM A: ULTRASONIC (TRON THEME) -->
    <div class="radar-panel theme-tron" id="panel-A">
      <div class="panel-header">
        <span class="panel-title">SYSTEM A: ULTRASONIC</span>
        <div class="controls">
          <input type="number" id="range-A" value="50" class="input-small" title="Range (cm)">
          <input type="text" id="ip-A" value="192.168.178.70">
          <button onclick="connectA()">CONNECT</button>
          <span id="status-A" class="status">OFFLINE</span>
        </div>
      </div>

      <div class="data-overlay data-display">
        <div class="data-row"><span class="label">FRONT:</span> <span class="value" id="dist-A-front">---</span></div>
        <div class="data-row"><span class="label">LEFT:</span> <span class="value" id="dist-A-left">---</span></div>
        <div class="data-row"><span class="label">RIGHT:</span> <span class="value" id="dist-A-right">---</span></div>
        <div class="data-row"><span class="label">BACK:</span> <span class="value" id="dist-A-back">---</span></div>
      </div>

      <canvas id="canvas-A"></canvas>
    </div>

    <!-- SYSTEM B: TOF (MATRIX THEME) -->
    <div class="radar-panel theme-matrix" id="panel-B">
      <div class="panel-header">
        <span class="panel-title">SYSTEM B: TOF LIDAR</span>
        <div class="controls">
          <input type="number" id="range-B" value="500" class="input-small" title="Range (mm)">
          <input type="text" id="ip-B" value="192.168.178.71">
          <button onclick="connectB()">CONNECT</button>
          <span id="status-B" class="status">OFFLINE</span>
        </div>
      </div>

      <div class="data-overlay data-display">
        <div class="data-row"><span class="label">ANGLE:</span> <span class="value" id="val-B-angle">0°</span></div>
        <div class="data-row"><span class="label">DISTANCE:</span> <span class="value" id="val-B-dist">---</span></div>
      </div>

      <canvas id="canvas-B"></canvas>
    </div>
  </div>

  <script>
    // --- CONFIG ---
    const CFG = {
      tron: { color: '#00f3ff', bg: '#001111', grid: '#003333' },
      matrix: { color: '#00ff41', bg: '#000000', grid: '#003300' }
    };

    // --- COMMON DRAWING ---
    function drawRadar(ctx, width, height, mapData, maxDist, angle, theme, multiScan) {
      const c = theme === 'tron' ? CFG.tron : CFG.matrix;

      // Fade Effect
      ctx.fillStyle = theme === 'tron' ? 'rgba(0,10,10,0.05)' : 'rgba(0,0,0,0.05)';
      ctx.fillRect(0, 0, width, height);

      const cx = width / 2;
      const cy = height / 2;
      const r = Math.min(cx, cy) - 40;

      // Grid Rings & Distance Labels
      ctx.strokeStyle = c.grid;
      ctx.lineWidth = 1;
      ctx.fillStyle = c.color;
      ctx.font = "10px Orbitron";
      ctx.textAlign = "center";
      ctx.textBaseline = "middle";

      ctx.beginPath();
      for (let i = 1; i <= 4; i++) {
        const radius = r * (i / 4);
        ctx.arc(cx, cy, radius, 0, Math.PI * 2);

        // Distance Labels (Top)
        const labelVal = Math.round((maxDist * (i / 4)));
        ctx.fillText(labelVal, cx, cy - radius - 8);
      }
      ctx.stroke();

      // Crosshairs
      ctx.beginPath();
      ctx.moveTo(cx - r, cy); ctx.lineTo(cx + r, cy);
      ctx.moveTo(cx, cy - r); ctx.lineTo(cx, cy + r);
      ctx.stroke();

      // Directional Labels
      ctx.font = "bold 12px Orbitron";
      ctx.fillText("FRONT", cx, cy - r - 20);
      ctx.fillText("BACK", cx, cy + r + 20);
      ctx.textAlign = "left";
      ctx.fillText("RIGHT", cx + r + 10, cy);
      ctx.textAlign = "right";
      ctx.fillText("LEFT", cx - r - 10, cy);

      // Map Drawing
      ctx.fillStyle = c.color;
      if (theme === 'tron') {
        ctx.shadowBlur = 3;
        ctx.shadowColor = c.color;
      } else {
        ctx.shadowBlur = 0;
      }

      for (let i = 0; i < 360; i++) {
        if (mapData[i] <= 0) continue;

        const rad = (i - 90) * (Math.PI / 180);
        let d = mapData[i];
        if (d > maxDist) d = maxDist;

        const distPx = (d / maxDist) * r;
        const x = cx + Math.cos(rad) * distPx;
        const y = cy + Math.sin(rad) * distPx;

        // Thinner dots for both
        if (theme === 'tron') {
          ctx.beginPath();
          ctx.arc(x, y, 1, 0, Math.PI * 2); // Reduced size to 1
          ctx.fill();
        } else {
          ctx.fillRect(x - 0.5, y - 0.5, 1, 1); // Reduced size to 1x1
        }
      }
      ctx.shadowBlur = 0; // Reset

      // Scanner
      // Red scanner line for both
      ctx.strokeStyle = '#ff0000';
      ctx.lineWidth = 2;

      const drawScanLine = (deg) => {
        const scanRad = (deg - 90) * (Math.PI / 180);
        ctx.beginPath();
        ctx.moveTo(cx, cy);
        ctx.lineTo(cx + Math.cos(scanRad) * r, cy + Math.sin(scanRad) * r);
        ctx.stroke();
      };

      drawScanLine(angle);

      // Multi-scan for Ultrasonic (4 sensors)
      if (multiScan) {
        drawScanLine(angle + 90);
        drawScanLine(angle + 180);
        drawScanLine(angle + 270);
      }
    }

    // --- SYSTEM A (Ultrasonic) ---
    const cvsA = document.getElementById('canvas-A');
    const ctxA = cvsA.getContext('2d');
    const mapA = new Array(360).fill(0);
    let wsA;
    let angleA = 0;

    function resizeA() {
      cvsA.width = cvsA.clientWidth;
      cvsA.height = cvsA.clientHeight;
    }

    function connectA() {
      const ip = document.getElementById('ip-A').value;
      if (wsA) wsA.close();
      wsA = new WebSocket('ws://' + ip + ':81/');

      wsA.onopen = () => {
        document.getElementById('status-A').innerText = "ONLINE";
        document.getElementById('status-A').classList.add('connected');
      };
      wsA.onclose = () => {
        document.getElementById('status-A').innerText = "OFFLINE";
        document.getElementById('status-A').classList.remove('connected');
      };
      wsA.onmessage = (e) => {
        try {
          const d = JSON.parse(e.data);
          angleA = d.angle;

          // Update Distances Text
          document.getElementById('dist-A-front').innerText = d.d_front + " cm";
          document.getElementById('dist-A-left').innerText = d.d_left + " cm";
          document.getElementById('dist-A-right').innerText = d.d_right + " cm";
          document.getElementById('dist-A-back').innerText = d.d_back + " cm";

          // Update 4 sectors
          const range = parseInt(document.getElementById('range-A').value) || 50;
          updateMap(mapA, d.angle, d.d_front, range);
          updateMap(mapA, d.angle + 90, d.d_left, range);
          updateMap(mapA, d.angle + 180, d.d_back, range);
          updateMap(mapA, d.angle + 270, d.d_right, range);
        } catch (err) { }
      };
    }

    // --- SYSTEM B (TOF) ---
    const cvsB = document.getElementById('canvas-B');
    const ctxB = cvsB.getContext('2d');
    const mapB = new Array(360).fill(0);
    let wsB;
    let angleB = 0;

    function resizeB() {
      cvsB.width = cvsB.clientWidth;
      cvsB.height = cvsB.clientHeight;
    }

    function connectB() {
      const ip = document.getElementById('ip-B').value;
      if (wsB) wsB.close();
      wsB = new WebSocket('ws://' + ip + ':81/');

      wsB.onopen = () => {
        document.getElementById('status-B').innerText = "ONLINE";
        document.getElementById('status-B').classList.add('connected');
      };
      wsB.onclose = () => {
        document.getElementById('status-B').innerText = "OFFLINE";
        document.getElementById('status-B').classList.remove('connected');
      };
      wsB.onmessage = (e) => {
        try {
          const d = JSON.parse(e.data);
          angleB = d.angle;
          let dist = d.distance;

          // Update Text
          document.getElementById('val-B-angle').innerText = angleB + "°";
          document.getElementById('val-B-dist').innerText = dist + " mm";

          if (dist > 8000 || dist <= 0) dist = 0;
          const a = d.angle % 360;
          mapB[a] = dist;

        } catch (err) { }
      };
    }

    // Helper
    function updateMap(map, deg, dist, max) {
      let a = deg % 360;
      if (a < 0) a += 360;
      if (dist <= 0 || dist > max) {
        map[a] = 0;
      } else {
        map[a] = dist;
      }
    }

    // Loop
    function loop() {
      // Get ranges from inputs
      const rangeA = parseInt(document.getElementById('range-A').value) || 50;
      const rangeB = parseInt(document.getElementById('range-B').value) || 500;

      // System A: TRON theme, Multi-Scan (4 lines)
      drawRadar(ctxA, cvsA.width, cvsA.height, mapA, rangeA, angleA, 'tron', true);

      // System B: Matrix theme, Single Scan
      drawRadar(ctxB, cvsB.width, cvsB.height, mapB, rangeB, angleB, 'matrix', false);

      requestAnimationFrame(loop);
    }

    window.onresize = () => { resizeA(); resizeB(); };
    resizeA(); resizeB();
    loop();

    // Auto-Connect
    setTimeout(() => {
      connectA();
      connectB();
    }, 1000);

  </script>
</body>

</html>